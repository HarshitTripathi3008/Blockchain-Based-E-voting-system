<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Election Commission Dashboard - BlockVotes</title>
  <link rel="stylesheet" href="/static/css/global.css">
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;700&family=Inter:wght@400;600&display=swap"
    rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/js-cookie@3.0.1/dist/js.cookie.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="/static/js/ui.js?v=2"></script>
  <style>
    .layout {
      display: flex;
      min-height: 100vh;
    }

    .sidebar {
      width: 250px;
      background: rgba(23, 23, 33, 0.9);
      border-right: 1px solid var(--glass-border);
      padding: 2rem 1rem;
      display: flex;
      flex-direction: column;
    }

    .main-content {
      flex: 1;
      padding: 2rem;
      overflow-y: auto;
    }

    .nav-btn {
      text-align: left;
      padding: 1rem;
      margin-bottom: 0.5rem;
      background: transparent;
      color: var(--text-muted);
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s;
      font-size: 1rem;
      width: 100%;
      font-family: var(--font-body);
    }

    .nav-btn:hover,
    .nav-btn.active {
      background: rgba(108, 92, 231, 0.1);
      color: #fff;
    }

    .stat-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1.5rem;
      margin-bottom: 2rem;
    }

    .stat-card {
      padding: 1.5rem;
      border-radius: 12px;
      background: var(--glass-bg);
      border: 1px solid var(--glass-border);
    }

    .stat-val {
      font-size: 2rem;
      font-weight: 700;
      color: var(--primary-color);
      margin-top: 0.5rem;
    }

    .stat-label {
      font-size: 0.9rem;
      color: var(--text-muted);
    }

    .chart-container {
      background: var(--glass-bg);
      border: 1px solid var(--glass-border);
      border-radius: 16px;
      padding: 2rem;
      margin-bottom: 2rem;
      height: 400px;
      position: relative;
    }
  </style>
</head>

<body>
  <!-- Hamburger Menu Button (Mobile Only) -->
  <button class="hamburger-btn" onclick="UI.toggleSidebar()" aria-label="Toggle Menu">
    <div class="hamburger-icon">
      <span></span>
      <span></span>
      <span></span>
    </div>
  </button>

  <!-- Sidebar Overlay (Mobile Only) -->
  <div class="sidebar-overlay" onclick="UI.closeSidebar()"></div>

  <div class="layout">
    <!-- Sidebar -->
    <aside class="sidebar">
      <div style="text-align: center; margin-bottom: 3rem;">
        <img src="/static/logo3.png" alt="Logo" style="width: 50px; margin-bottom: 0.5rem;" />
        <h3 style="margin:0;">BlockVotes</h3>
      </div>
      <nav style="flex: 1;">
        <button id="dashboardBtn" class="nav-btn active">Dashboard</button>
      </nav>
      <button id="logoutBtn" class="nav-btn" style="color: var(--error-color); margin-top: auto;">Logout</button>
    </aside>

    <main class="main-content">
      <div style="display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 2rem;">
        <div>
          <h2>Election Observer Dashboard</h2>
          <p style="color: var(--text-muted);">Real-time election monitoring</p>
        </div>
        <div style="text-align: right; font-size: 0.9rem;">
          <div id="companyEmailDisplay" style="color: #fff; font-weight: 600;"></div>
          <div id="electionAddrDisplay" style="color: var(--text-muted); font-family: monospace;"></div>
        </div>
      </div>

      <div class="glass-card" style="margin-bottom: 2rem;">
        <h3 style="margin-bottom: 0.5rem;">Current Election</h3>
        <h1 id="electionName" style="color: var(--accent-color);">â€”</h1>
        <p id="electionDesc" style="color: var(--text-muted); margin-top: 0.5rem;">â€”</p>
      </div>

      <div class="stat-grid">
        <div class="stat-card">
          <div class="stat-label">Total Candidates</div>
          <div id="candidatesCount" class="stat-val">â€”</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Total Voters</div>
          <div id="votersCount" class="stat-val">â€”</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Total Votes Cast</div>
          <div id="votesCount" class="stat-val">â€”</div>
        </div>
      </div>

      <!-- Charts Section -->
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-bottom: 2rem;">
        <div class="chart-container fade-in">
          <h3 style="margin-bottom: 1rem;">Live Results</h3>
          <canvas id="resultsChart"></canvas>
        </div>
        <div class="chart-container fade-in">
          <h3 style="margin-bottom: 1rem;">Turnout Percentage</h3>
          <canvas id="turnoutChart"></canvas>
        </div>
      </div>


    </main>
  </div>

  <script>
    // --- utility helpers (safe JSON parsing) ---
    let resultsChart = null;



    function getElectionAddress() {
      const cookie = Cookies.get('address');
      if (cookie) return cookie;
      const params = new URLSearchParams(window.location.search);
      return params.get('address') || '';
    }

    function getCompanyEmail() {
      return Cookies.get('company_email') || localStorage.getItem('companyEmail') || '';
    }

    function updateHeaderDisplays() {
      document.getElementById('companyEmailDisplay').textContent = 'ðŸ‘ï¸ Observer Mode';
      const addr = getElectionAddress();
      document.getElementById('electionAddrDisplay').textContent = addr ? `${addr.substr(0, 10)}...${addr.substr(-8)}` : 'No election selected';
    }

    // --- load dashboard data (keep original behavior but robust) ---
    async function loadDashboard() {
      const addr = getElectionAddress();
      if (!addr) {
        document.getElementById('electionName').textContent = 'No election selected';
        document.getElementById('electionDesc').textContent = 'Please create an election first.';
        return;
      }

      UI.showLoader('Loading Stats...');
      const encoded = encodeURIComponent(addr);
      try {
        // election details
        const respDetails = await fetch(`/api/elections/${encoded}/details`, { headers: { 'Accept': 'application/json' } });
        if (respDetails.ok) {
          const body = await UI.safeJson(respDetails);
          const electionName = body?.data?.election_name || body?.election_name || "Unnamed election";
          const electionDesc = body?.data?.election_desc || body?.election_desc || "";
          document.getElementById('electionName').textContent = electionName;
          document.getElementById('electionDesc').textContent = electionDesc;
        } else {
          document.getElementById('electionName').textContent = 'Unnamed election';
        }

        // candidates
        const respCandidates = await fetch(`/api/elections/${encoded}/candidates`, { headers: { 'Accept': 'application/json' } });
        let candidates = [];
        if (respCandidates.ok) {
          const cbody = await safeJson(respCandidates);
          if (Array.isArray(cbody)) candidates = cbody;
          else candidates = cbody?.candidates || cbody?.data?.candidates || [];
        }
        document.getElementById('candidatesCount').textContent = String(candidates.length || 0);

        // voters
        const respVoters = await fetch(`/api/elections/${encoded}/voters`, { headers: { 'Accept': 'application/json' } });
        let voters = [];
        if (respVoters.ok) {
          const vbody = await safeJson(respVoters);
          voters = Array.isArray(vbody?.voters) ? vbody.voters : (Array.isArray(vbody) ? vbody : []);
        }
        document.getElementById('votersCount').textContent = String(voters.length || 0);

        // total votes (sum up voteCount/votes fields)
        const totalVotes = (candidates || []).reduce((sum, c) => {
          const v = Number(c.voteCount || c.votes || c.vote_count || 0);
          return sum + (isNaN(v) ? 0 : v);
        }, 0);
        document.getElementById('votesCount').textContent = String(totalVotes);

        renderChart(candidates);
        renderTurnoutChart(totalVotes, voters.length);
      } catch (err) {
        console.warn('Failed to load dashboard data', err);
        UI.toast('Failed to load dashboard data', 'error');
      } finally {
        UI.hideLoader();
      }
    }

    let turnoutChart = null;
    function renderTurnoutChart(votes, totalVoters) {
      const ctx = document.getElementById('turnoutChart').getContext('2d');
      const percentage = totalVoters > 0 ? ((votes / totalVoters) * 100).toFixed(1) : 0;

      if (turnoutChart) turnoutChart.destroy();

      turnoutChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: ['Voted', 'Not Voted'],
          datasets: [{
            data: [votes, Math.max(0, totalVoters - votes)],
            backgroundColor: ['#00b894', '#2d3436'],
            borderWidth: 0
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          cutout: '70%',
          plugins: {
            legend: { position: 'bottom', labels: { color: '#fff' } },
            title: {
              display: true,
              text: `${percentage}% Turnout`,
              color: '#fff',
              font: { size: 16 }
            }
          }
        }
      });
    }

    function renderChart(candidates) {
      // ... (existing bar chart logic)
      const ctx = document.getElementById('resultsChart').getContext('2d');
      const labels = candidates.map(c => c.name || 'Unknown');
      const data = candidates.map(c => Number(c.voteCount || c.votes || 0));

      if (resultsChart) {
        resultsChart.destroy();
      }

      resultsChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [{
            label: '# of Votes',
            data: data,
            backgroundColor: 'rgba(108, 92, 231, 0.6)', // solid color for all? No, let's keep array if preferred or simple
            backgroundColor: [
              'rgba(108, 92, 231, 0.6)', 'rgba(9, 132, 227, 0.6)', 'rgba(0, 184, 148, 0.6)',
              'rgba(253, 203, 110, 0.6)', 'rgba(225, 112, 85, 0.6)', 'rgba(214, 48, 49, 0.6)'
            ],
            borderColor: [
              'rgba(108, 92, 231, 1)', 'rgba(9, 132, 227, 1)', 'rgba(0, 184, 148, 1)',
              'rgba(253, 203, 110, 1)', 'rgba(225, 112, 85, 1)', 'rgba(214, 48, 49, 1)'
            ],
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: { beginAtZero: true, ticks: { color: '#b2bec3' }, grid: { color: 'rgba(255, 255, 255, 0.1)' } },
            x: { ticks: { color: '#b2bec3' }, grid: { display: false } }
          },
          plugins: { legend: { display: false } }
        }
      });
    }



    // --- get winner from candidates list (selects highest votes) ---
    async function computeWinner(electionAddress) {
      if (!electionAddress) return null;
      const encoded = encodeURIComponent(electionAddress);
      try {
        const resp = await fetch(`/api/elections/${encoded}/candidates`, { headers: { 'Accept': 'application/json' } });
        if (!resp.ok) return null;
        const body = await safeJson(resp);
        let candidates = [];
        if (Array.isArray(body)) candidates = body;
        else candidates = body?.candidates || body?.data?.candidates || [];

        if (!candidates || candidates.length === 0) return null;

        let winner = null;
        let maxVotes = -1;
        for (const c of candidates) {
          const v = Number(c.voteCount || c.votes || c.vote_count || 0);
          const votes = isNaN(v) ? 0 : v;
          if (votes > maxVotes) {
            maxVotes = votes;
            winner = c;
          }
        }
        if (!winner && candidates.length > 0) winner = candidates[0];

        if (winner) {
          return {
            name: winner.name || winner.candidate_name || winner.candidate || '(unnamed)',
            email: winner.email || winner.candidate_email || '',
            voteCount: Number(winner.voteCount || winner.votes || winner.vote_count || 0)
          };
        }
        return null;
      } catch (err) {
        console.error('computeWinner error', err);
        return null;
      }
    }


    // --- navigation & event wiring ---
    function navTo(page) {
      const addr = getElectionAddress();
      const q = addr ? `?address=${encodeURIComponent(addr)}` : '';
      window.location.href = `${page}${q}`;
    }

    document.getElementById('logoutBtn').addEventListener('click', function () {
      Cookies.remove('address', { path: '/' });
      window.location.href = 'observer_login.html';
    });

    // --- init page ---
    updateHeaderDisplays();
    loadDashboard();
  </script>
</body>

</html>