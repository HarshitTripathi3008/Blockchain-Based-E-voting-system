<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Vote - BlockVotes</title>
  <link rel="icon" type="image/png" href="/static/logo3.png">
  <link rel="stylesheet" href="/static/css/global.css">
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;700&family=Inter:wght@400;600&display=swap"
    rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/js-cookie@3.0.1/dist/js.cookie.min.js"></script>
  <script src="/static/js/ui.js?v=2"></script>
  <style>
    body {
      margin: 0;
      display: flex;
      min-height: 100vh;
      background: var(--bg-color);
      color: var(--text-color);
    }

    /* Layout */
    .layout {
      display: flex;
      width: 100%;
    }

    .sidebar {
      width: 250px;
      background: rgba(23, 23, 33, 0.95);
      border-right: 1px solid var(--glass-border);
      padding: 2rem 1.5rem;
      display: flex;
      flex-direction: column;
      flex-shrink: 0;
    }

    .main {
      flex: 1;
      padding: 3rem;
      overflow-y: auto;
    }

    /* Stats Cards */
    .stats-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 1.5rem;
      margin-bottom: 3rem;
    }

    .stat-card {
      background: var(--glass-bg);
      border: 1px solid var(--glass-border);
      padding: 1.5rem;
      border-radius: 16px;
    }

    /* Voting Section */
    .voting-section {
      background: linear-gradient(135deg, rgba(32, 32, 48, 0.6), rgba(23, 23, 33, 0.8));
      border-radius: 20px;
      padding: 2.5rem;
      border: 1px solid var(--glass-border);
      text-align: center;
      max-width: 800px;
      margin: 0 auto;
    }

    /* Modal Candidates */
    .candidate-option {
      display: flex;
      align-items: center;
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid transparent;
      padding: 1rem;
      border-radius: 12px;
      margin-bottom: 0.8rem;
      cursor: pointer;
      transition: all 0.2s;
    }

    .candidate-option:hover,
    .candidate-option.selected {
      background: rgba(108, 92, 231, 0.1);
      border-color: var(--accent-color);
    }

    .candidate-img {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      object-fit: cover;
      margin-right: 1rem;
    }

    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.8);
      backdrop-filter: blur(5px);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 100;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s;
    }

    .modal-overlay.active {
      opacity: 1;
      pointer-events: all;
    }

    .modal-box {
      background: #181825;
      width: 90%;
      max-width: 600px;
      padding: 2rem;
      border-radius: 20px;
      border: 1px solid var(--glass-border);
      box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5);
      max-height: 85vh;
      overflow-y: auto;
    }

    /* Steps */
    .step-indicator {
      font-size: 0.8rem;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: var(--success-color);
      background: rgba(16, 185, 129, 0.1);
      padding: 0.4rem 0.8rem;
      border-radius: 20px;
      margin-bottom: 1rem;
      display: inline-block;
    }
  </style>
</head>

<body>
  <!-- Hamburger Menu Button (Mobile Only) -->
  <button class="hamburger-btn" onclick="UI.toggleSidebar()" aria-label="Toggle Menu">
    <div class="hamburger-icon">
      <span></span>
      <span></span>
      <span></span>
    </div>
  </button>

  <!-- Sidebar Overlay (Mobile Only) -->
  <div class="sidebar-overlay" onclick="UI.closeSidebar()"></div>

  <div class="layout">
    <!-- Sidebar -->
    <aside class="sidebar">
      <div style="display:flex; align-items:center; gap:10px; margin-bottom: 3rem;">
        <img src="/static/logo3.png" alt="logo" style="width:40px; height:40px;">
        <h3 style="margin:0; font-size:1.2rem;">BlockVotes</h3>
      </div>

      <div style="font-size: 0.9rem; color: var(--text-muted); margin-bottom: 0.5rem;">Logged in as:</div>
      <div id="voterEmailDisplay"
        style="font-size: 0.95rem; font-weight: 600; color: #fff; margin-bottom: 2rem; word-break: break-all;">â€”</div>

      <button id="downloadIdBtn" class="btn btn-primary" style="margin-top: 1rem; width: 100%;">
        Download Voter ID (PDF)
      </button>

      <button id="emailIdBtn" class="btn btn-outline"
        style="color: var(--accent-color); border-color: rgba(162, 155, 254, 0.3); margin-top: 0.5rem; width: 100%;">
        Email ID Card
      </button>

      <button id="logoutBtn" class="btn btn-outline"
        style="color: var(--error-color); border-color: rgba(239, 68, 68, 0.3); margin-top: auto; width: 100%;">
        Sign Out
      </button>
    </aside>

    <!-- Main Content -->
    <main class="main">
      <div style="max-width: 1000px; margin: 0 auto;">

        <!-- Header -->
        <div style="margin-bottom: 3rem;">
          <div class="step-indicator">SECURE ELECTION</div>
          <h1 id="election-name"
            style="font-size: 2.5rem; margin-bottom: 0.5rem; background: linear-gradient(to right, #fff, #a29bfe); -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent;">
            Loading Election...</h1>
          <p id="election-desc" style="color: var(--text-muted); font-size: 1.1rem; max-width: 600px;"></p>
        </div>

        <!-- Stats -->
        <div class="stats-container">
          <div class="stat-card">
            <div style="color: var(--text-muted); font-size: 0.9rem;">Registered Voters</div>
            <div id="votersCount" style="font-size: 2rem; font-weight: 700; color: #fff; margin-top: 0.5rem;">â€”</div>
          </div>
          <div class="stat-card">
            <div style="color: var(--text-muted); font-size: 0.9rem;">Candidates</div>
            <div id="candidatesCount" style="font-size: 2rem; font-weight: 700; color: #fff; margin-top: 0.5rem;">â€”
            </div>
          </div>
          <div class="stat-card">
            <div style="color: var(--text-muted); font-size: 0.9rem;">Election Code (Address)</div>
            <div id="addressDisplay"
              style="font-size: 0.9rem; color: var(--primary-color); margin-top: 0.5rem; word-break: break-all; font-family: monospace;">
              â€”</div>
          </div>
        </div>

        <!-- Call to Action -->
        <div class="voting-section fade-in">
          <h2 style="margin-bottom: 1rem;">Cast Your Vote</h2>
          <p style="color: var(--text-muted); margin-bottom: 2rem;">
            Review the candidates carefully. Your vote is immutable and secured on the Ethereum blockchain.
          </p>
          <button id="castVoteBtn" class="btn btn-primary" style="padding: 1rem 3rem; font-size: 1.1rem;">
            Proceed to Voting
          </button>
        </div>

      </div>
    </main>
  </div>

  <!-- Voting Modal -->
  <div id="voteModal" class="modal-overlay">
    <div class="modal-box slide-up">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 1.5rem;">
        <h2 style="margin:0;">Select Candidate</h2>
        <button id="closeModal"
          style="background:none; border:none; color: var(--text-muted); font-size: 1.5rem; cursor: pointer;">&times;</button>
      </div>

      <div id="modalLoading" style="text-align: center; color: var(--text-muted); padding: 2rem;">Loading candidates...
      </div>

      <div id="candidatesContainer"></div>

      <!-- OTP Section -->
      <div id="otpSection"
        style="margin-top: 1.5rem; border-top: 1px solid var(--glass-border); padding-top: 1rem; display:none;">
        <h4 style="margin-bottom:0.5rem; color:var(--accent-color);">Security Verification</h4>
        <p style="font-size:0.9rem; color:var(--text-muted); margin-bottom:1rem;">Review your selection above. To
          confirm, enter the OTP sent to your email.</p>
        <div style="display: flex; gap: 0.5rem;">
          <input id="voteOtpInput" type="text" placeholder="Enter OTP"
            style="flex:1; padding:0.8rem; border-radius:8px; border:1px solid var(--glass-border); background:rgba(0,0,0,0.2); color:#fff; font-size:1rem; text-align:center; letter-spacing:2px;">
          <button id="sendVoteOtpBtn" class="btn btn-outline" style="white-space:nowrap;">Send OTP</button>
        </div>
      </div>

      <div style="margin-top: 2rem; text-align: right;">
        <button id="submitVote" class="btn btn-primary" disabled style="width: 100%;">Confirm Vote</button>
      </div>
    </div>
  </div>

  <script>
    // --- Utils ---


    function getElectionAddress() {
      const params = new URLSearchParams(window.location.search);
      return params.get('address') || '';
    }

    function getVoterEmail() {
      return Cookies.get('voter_email') || localStorage.getItem('voterEmail') || '';
    }

    function escapeHtml(text) {
      return String(text || '').replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#039;');
    }

    // --- Data Loading ---
    async function loadData() {
      const address = getElectionAddress();
      const voter = getVoterEmail();

      if (!address || !voter) {
        UI.toast('Session invalid. Redirecting...', 'error');
        setTimeout(() => window.location.href = 'voter_login.html', 1500);
        return;
      }

      document.getElementById('voterEmailDisplay').textContent = voter;
      document.getElementById('addressDisplay').textContent = address;

      try {
        // Details
        const resp = await fetch(`/api/elections/${encodeURIComponent(address)}/details`, { headers: { 'Accept': 'application/json' } });
        if (resp.ok) {
          const data = await UI.safeJson(resp);
          document.getElementById('election-name').textContent = data?.data?.election_name || 'Election';
          document.getElementById('election-desc').textContent = data?.data?.election_desc || '';
        }

        // Stats
        const respCands = await fetch(`/api/elections/${encodeURIComponent(address)}/candidates`, { headers: { 'Accept': 'application/json' } });
        if (respCands.ok) {
          const cData = await UI.safeJson(respCands);
          const count = (cData.candidates || cData || []).length;
          document.getElementById('candidatesCount').textContent = count;
        }

        const respVoters = await fetch(`/api/elections/${encodeURIComponent(address)}/voters`, { headers: { 'Accept': 'application/json' } });
        if (respVoters.ok) {
          const vData = await UI.safeJson(respVoters);
          const count = (vData.voters || vData || []).length;
          document.getElementById('votersCount').textContent = count;
        }

      } catch (err) {
        console.error(err);
      }
    }

    // --- Modal Logic ---
    const modal = document.getElementById('voteModal');
    const container = document.getElementById('candidatesContainer');
    const submitBtn = document.getElementById('submitVote');
    let selectedCandidateId = null;

    document.getElementById('castVoteBtn').onclick = () => {
      modal.classList.add('active');
      loadCandidatesForModal();
    };
    document.getElementById('closeModal').onclick = () => modal.classList.remove('active');

    async function loadCandidatesForModal() {
      const address = getElectionAddress();
      container.innerHTML = '';
      submitBtn.disabled = true;
      document.getElementById('modalLoading').style.display = 'block';

      try {
        const resp = await fetch(`/api/elections/${encodeURIComponent(address)}/candidates`, { headers: { 'Accept': 'application/json' } });
        const data = await UI.safeJson(resp);

        if (!data) {
          throw new Error("Failed to load candidates data");
        }

        const candidates = data.candidates || data || [];

        document.getElementById('modalLoading').style.display = 'none';

        if (candidates.length === 0) {
          container.innerHTML = '<div style="text-align:center; padding:1rem;">No candidates found.</div>';
          return;
        }

        candidates.forEach((c, idx) => {
          const el = document.createElement('div');
          el.className = 'candidate-option';

          // Image handling
          const imgRef = c.imageHash || c.cid || '';
          let imgUrl = '/static/default-candidate.png';
          if (imgRef.startsWith('http')) imgUrl = imgRef;
          else if (imgRef) imgUrl = `https://ipfs.io/ipfs/${imgRef}`;

          el.innerHTML = `
                    <div style="flex-shrink:0;">
                        <img src="${imgUrl}" class="candidate-img" onerror="this.src='/static/default-candidate.png'">
                    </div>
                    <div style="flex:1;">
                        <div style="font-weight:600; font-size:1.1rem; color:#fff;">${escapeHtml(c.name)}</div>
                         <div style="font-size:0.9rem; color:var(--text-muted);">${escapeHtml(c.description)}</div>
                         ${(c.manifestoUrl || c.manifesto_url) ? `<div style="margin-top:4px;"><a href="${c.manifestoUrl || c.manifesto_url}" target="_blank" style="color:var(--accent-color); font-size:0.8rem; text-decoration:none;">ðŸ“„ View Manifesto</a></div>` : ''}
                    </div>
                    <div style="width: 20px; height: 20px; border: 2px solid var(--text-muted); border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                        <div class="dot" style="width: 10px; height: 10px; background: var(--accent-color); border-radius: 50%; opacity: 0; transition: opacity 0.2s;"></div>
                    </div>
                `;

          el.onclick = () => {
            // Select logic
            document.querySelectorAll('.candidate-option').forEach(x => {
              x.classList.remove('selected');
              x.querySelector('.dot').style.opacity = '0';
              x.querySelector('.candidate-option > div:last-child').style.borderColor = 'var(--text-muted)';
            });
            el.classList.add('selected');
            el.querySelector('.dot').style.opacity = '1';
            el.querySelector('.candidate-option > div:last-child').style.borderColor = 'var(--accent-color)';

            selectedCandidateId = idx;
            // Show OTP section
            document.getElementById('otpSection').style.display = 'block';
            document.getElementById('submitVote').textContent = `Confirm & Vote`;
            submitBtn.disabled = false;
          };
          container.appendChild(el);
        });

      } catch (err) {
        console.error(err);
        container.innerHTML = '<div style="color:var(--error-color);">Failed to load candidates.</div>';
      }
    }

    document.getElementById('sendVoteOtpBtn').onclick = async () => {
      const btn = document.getElementById('sendVoteOtpBtn');
      const email = getVoterEmail();
      const addr = getElectionAddress();

      btn.disabled = true;
      btn.textContent = "Sending...";

      try {
        const resp = await fetch('/api/voters/send-otp', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, election_address: addr })
        });
        const json = await UI.safeJson(resp);
        if (resp.ok) {
          UI.toast(json?.message || "OTP Sent", "success");
          btn.textContent = "Resend OTP";
        } else {
          UI.toast(json?.message || "Failed to send OTP", "error");
          btn.textContent = "Send OTP";
        }
      } catch (e) {
        UI.toast("Error sending OTP", "error");
        btn.textContent = "Send OTP";
      } finally {
        setTimeout(() => btn.disabled = false, 5000);
      }
    };

    submitBtn.onclick = async () => {
      if (selectedCandidateId === null) return;

      submitBtn.disabled = true;
      submitBtn.style.opacity = 0.7;
      UI.showLoader('Submitting Vote to Blockchain...');

      try {
        const payload = {
          candidate_id: selectedCandidateId,
          voter_email: getVoterEmail(),
          election_address: getElectionAddress(),
          otp: document.getElementById('voteOtpInput').value
        };

        if (!payload.otp) {
          UI.toast("Please enter OTP", "warning");
          submitBtn.disabled = false;
          submitBtn.style.opacity = 1;
          UI.hideLoader();
          return;
        }

        const resp = await fetch(`/api/elections/${encodeURIComponent(payload.election_address)}/vote`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        const json = await UI.safeJson(resp);

        if (resp.ok || json?.status === 'success' || json?.success === true) {
          UI.toast('Vote Cast Successfully!', 'success');
          modal.classList.remove('active');
          // Disable voting button
          document.getElementById('castVoteBtn').disabled = true;
          document.getElementById('castVoteBtn').textContent = 'Vote Cast âœ”';
          document.getElementById('castVoteBtn').style.background = 'var(--text-muted)';
        } else {
          throw new Error(json?.message || 'Vote failed');
        }

      } catch (err) {
        console.error(err);
        UI.toast('Error: ' + err.message, 'error');
      } finally {
        submitBtn.disabled = false;
        submitBtn.style.opacity = 1;
        UI.hideLoader();
      }
    };

    document.getElementById('logoutBtn').onclick = () => {
      Cookies.remove('voter_email'); Cookies.remove('address');
      window.location.href = 'homepage.html';
    };

    document.getElementById('downloadIdBtn').onclick = () => {
      const fn = (id) => {
        window.location.href = `/api/voters/${id}/card`;
      };
      resolveVoterId(document.getElementById('downloadIdBtn'), fn);
    };

    document.getElementById('emailIdBtn').onclick = () => {
      const fn = (id) => {
        const btn = document.getElementById('emailIdBtn');
        btn.textContent = "Sending Email...";
        btn.disabled = true;

        fetch(`/api/voters/${id}/card/email`, { method: 'POST' })
          .then(r => r.json())
          .then(json => {
            if (json.status === 'success') {
              UI.toast('ID Card sent to email!', 'success');
            } else {
              UI.toast(json.message || 'Failed to send email', 'error');
            }
          })
          .catch(e => {
            console.error(e);
            UI.toast('Network error', 'error');
          })
          .finally(() => {
            btn.textContent = "Email ID Card";
            btn.disabled = false;
          });
      };
      resolveVoterId(document.getElementById('emailIdBtn'), fn);
    };

    // Helper to resolve ID for ID card actions
    function resolveVoterId(btnElement, callback) {
      const voterEmail = getVoterEmail();
      const address = getElectionAddress();
      const storedId = Cookies.get('voter_id');

      // Optimization: Use stored ID if available
      if (storedId) {
        callback(storedId);
        return;
      }

      btnElement.disabled = true;
      const originalText = btnElement.textContent;
      btnElement.textContent = "Processing...";

      fetch(`/api/elections/${encodeURIComponent(address)}/voters`)
        .then(r => r.json())
        .then(data => {
          const voters = data.voters || [];
          const me = voters.find(v => v.email === voterEmail);
          if (me && (me.id || me._id)) {
            const id = me.id || me._id;
            // Restore button state before callback takes over (or if it's sync)
            btnElement.disabled = false;
            btnElement.textContent = originalText;
            callback(id);
          } else {
            UI.toast("Voter record not found", "error");
            btnElement.disabled = false;
            btnElement.textContent = originalText;
          }
        })
        .catch(e => {
          console.error(e);
          UI.toast("Error finding voter ID", "error");
          btnElement.disabled = false;
          btnElement.textContent = originalText;
        });
    }

    // Init
    loadData();
  </script>
</body>

</html>