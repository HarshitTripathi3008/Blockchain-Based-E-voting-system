<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Create Election - SecureVote -- E-Voting System</title>
  <link rel="stylesheet" href="/static/css/global.css">
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;700&family=Inter:wght@400;600&display=swap"
    rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/js-cookie@3.0.1/dist/js.cookie.min.js"></script>
  <script src="/static/js/ui.js?v=2"></script>
  <style>
    body {
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
    }

    .create-card {
      max-width: 600px;
      width: 100%;
    }
  </style>
</head>

<body>
  <div class="glass-card create-card fade-in">
    <div style="text-align: center;">
      <img src="/static/logo3.png" alt="Logo" style="width: 80px; margin-bottom: 1rem;" />
      <h2 style="margin-bottom: 0.5rem;">Create New Election</h2>
      <p style="color: var(--text-muted); margin-bottom: 2rem;">Deploying a new election contract to the blockchain.</p>
    </div>

    <form id="createElectionForm" novalidate>
      <div style="margin-bottom: 1.5rem;">
        <input id="electionName" name="electionName" type="text" required
          placeholder="Election Name (e.g., 'Student Council 2026')" />
      </div>

      <div style="margin-bottom: 2rem;">
        <textarea id="electionDescription" name="electionDescription" required
          placeholder="Brief description of the election..." rows="4"></textarea>
      </div>

      <button id="submitButton" type="submit" class="btn btn-primary" style="width: 100%;">Create Election</button>

      <div
        style="margin-top: 1.5rem; padding: 1rem; background: rgba(59, 130, 246, 0.1); border-left: 3px solid #3b82f6; border-radius: 4px; font-size: 0.9rem;">
        <strong style="color: #60a5fa;">Note:</strong> This process interacts with the blockchain and may take 15-30
        seconds. Please do not close the window.
      </div>
    </form>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const form = document.getElementById('createElectionForm');
      const submitButton = document.getElementById('submitButton');
      const electionName = document.getElementById('electionName');
      const electionDescription = document.getElementById('electionDescription');

      const companyEmail = Cookies.get('company_email');
      if (!companyEmail) {
        UI.toast('Please login to create an election.', 'error');
        window.location.href = 'company_login.html';
        return;
      }

      form.addEventListener('submit', async function (event) {
        event.preventDefault();
        await createElection();
      });

      async function createElection() {
        submitButton.disabled = true;
        submitButton.style.opacity = 0.6;
        UI.showLoader('Deploying Election Contract...');

        try {
          const name = electionName.value.trim();
          const description = electionDescription.value.trim();
          if (!name || !description) {
            throw new Error('Please fill in all fields.');
          }

          const controller = new AbortController();
          const timeout = setTimeout(() => controller.abort(), 60000); // 60s timeout for blockchain

          const payload = {
            company_email: companyEmail,
            election_name: name,
            election_description: description
          };

          const response = await fetch('/api/elections/create', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
            body: JSON.stringify(payload),
            signal: controller.signal
          });

          clearTimeout(timeout);

          let result = null;
          try { result = await response.json(); } catch (err) { throw new Error('Server returned invalid response'); }

          if (response.ok && (result.success === true || result.status === 'success') && result.election_address) {
            Cookies.set('address', result.election_address, { expires: 1, path: '/' });
            UI.toast('Election created successfully!', 'success');
            setTimeout(() => {
              window.location.href = `company_dashboard.html?address=${encodeURIComponent(result.election_address)}`;
            }, 1000);
            return;
          }

          throw new Error(result.message || result.error || 'Failed to create election');

        } catch (error) {
          console.error('Election creation error:', error);
          UI.toast(error.message || 'An error occurred', 'error');
        } finally {
          submitButton.disabled = false;
          submitButton.style.opacity = 1;
          UI.hideLoader();
        }
      }
    });
  </script>
</body>

</html>