<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Election Commission Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet"/>
  <script src="https://cdn.jsdelivr.net/npm/js-cookie@3.0.1/dist/js.cookie.min.js"></script>
  <style>
    /* minimal compatibility styles kept */
  </style>
</head>
<body class="bg-gray-100 flex min-h-screen">
  <!-- Sidebar -->
  <aside class="w-60 h-screen bg-blue-900 text-white flex flex-col pt-10">
    <img src="../static/logo3.png" alt="Logo" class="w-16 mx-auto mb-6" />
    <nav class="space-y-2 px-4">
      <button id="dashboardBtn" class="w-full text-left block px-4 py-2 hover:bg-blue-700 rounded">Dashboard</button>
      <button id="candidatesBtn" class="w-full text-left block px-4 py-2 hover:bg-blue-700 rounded">Candidate List</button>
      <button id="votersBtn" class="w-full text-left block px-4 py-2 hover:bg-blue-700 rounded">Voter List</button>
      <button id="createBtn" class="w-full text-left block px-4 py-2 hover:bg-blue-700 rounded">Create Election</button>
      <button id="logoutBtn" class="w-full mt-4 px-4 py-2 bg-red-600 hover:bg-red-700 rounded">Logout</button>
    </nav>
  </aside>

  <main class="flex-1 p-10">
    <div class="flex items-center justify-between mb-8">
      <h2 class="text-3xl font-bold text-blue-900">Election Commission Dashboard</h2>
      <div class="text-right">
        <div id="companyEmailDisplay" class="text-gray-700"></div>
        <div id="electionAddrDisplay" class="text-sm text-gray-500"></div>
      </div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
      <div class="bg-white p-6 rounded shadow">
        <div class="text-sm text-gray-500">Total Candidates</div>
        <div id="candidatesCount" class="text-2xl font-bold text-gray-800">—</div>
      </div>
      <div class="bg-white p-6 rounded shadow">
        <div class="text-sm text-gray-500">Total Voters</div>
        <div id="votersCount" class="text-2xl font-bold text-gray-800">—</div>
      </div>
      <div class="bg-white p-6 rounded shadow">
        <div class="text-sm text-gray-500">Total Votes</div>
        <div id="votesCount" class="text-2xl font-bold text-gray-800">—</div>
      </div>
    </div>

    <section class="bg-white p-6 rounded shadow mb-6">
      <h3 class="text-xl font-semibold mb-2">Election Details</h3>
      <p id="electionName" class="text-gray-800 mb-1">—</p>
      <p id="electionDesc" class="text-gray-600 text-sm">—</p>
    </section>

    <div id="actions" class="flex gap-4">
      <button id="viewCandidates" class="px-5 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700">View Candidates</button>
      <button id="manageVoters" class="px-5 py-2 bg-green-600 text-white rounded hover:bg-green-700">Manage Voters</button>
      <button id="endElection" class="px-5 py-2 bg-red-500 text-white rounded hover:bg-red-600">End Election (mail)</button>
    </div>
  </main>

  <script>
    // --- utility helpers (safe JSON parsing) ---
    async function safeJson(resp) {
      try { return await resp.json(); } catch { return null; }
    }

    function getElectionAddress() {
      const cookie = Cookies.get('address');
      if (cookie) return cookie;
      const params = new URLSearchParams(window.location.search);
      return params.get('address') || '';
    }

    function getCompanyEmail() {
      return Cookies.get('company_email') || localStorage.getItem('companyEmail') || '';
    }

    function updateHeaderDisplays() {
      document.getElementById('companyEmailDisplay').textContent = getCompanyEmail() ? `Account: ${getCompanyEmail()}` : '';
      const addr = getElectionAddress();
      document.getElementById('electionAddrDisplay').textContent = addr ? `Address: ${addr}` : 'No election selected';
    }

    // --- load dashboard data (keep original behavior but robust) ---
    async function loadDashboard() {
      const addr = getElectionAddress();
      if (!addr) {
        document.getElementById('electionName').textContent = 'No election selected';
        document.getElementById('electionDesc').textContent = '';
        return;
      }

      const encoded = encodeURIComponent(addr);
      try {
        // election details
        const respDetails = await fetch(`/api/elections/${encoded}/details`, { headers: { 'Accept': 'application/json' }});
        if (respDetails.ok) {
          const body = await safeJson(respDetails);
          const electionName = body?.data?.election_name || body?.election_name || "Unnamed election";
          const electionDesc = body?.data?.election_desc || body?.election_desc || "";
          document.getElementById('electionName').textContent = electionName;
          document.getElementById('electionDesc').textContent = electionDesc;
        } else {
          document.getElementById('electionName').textContent = 'Unnamed election';
          document.getElementById('electionDesc').textContent = '';
        }

        // candidates
        const respCandidates = await fetch(`/api/elections/${encoded}/candidates`, { headers: { 'Accept': 'application/json' }});
        let candidates = [];
        if (respCandidates.ok) {
          const cbody = await safeJson(respCandidates);
          if (Array.isArray(cbody)) candidates = cbody;
          else candidates = cbody?.candidates || cbody?.data?.candidates || [];
        }
        document.getElementById('candidatesCount').textContent = String(candidates.length || 0);

        // voters
        const respVoters = await fetch(`/api/elections/${encoded}/voters`, { headers: { 'Accept': 'application/json' }});
        let voters = [];
        if (respVoters.ok) {
          const vbody = await safeJson(respVoters);
          voters = Array.isArray(vbody?.voters) ? vbody.voters : (Array.isArray(vbody) ? vbody : []);
        }
        document.getElementById('votersCount').textContent = String(voters.length || 0);

        // total votes (sum up voteCount/votes fields)
        const totalVotes = (candidates || []).reduce((sum, c) => {
          const v = Number(c.voteCount || c.votes || c.vote_count || 0);
          return sum + (isNaN(v) ? 0 : v);
        }, 0);
        document.getElementById('votesCount').textContent = String(totalVotes);

      } catch (err) {
        console.warn('Failed to load dashboard data', err);
      }
    }

    // --- get winner candidate from candidates list (selects highest votes) ---
    // returns an object { name, email, voteCount } or null
    async function computeWinner(electionAddress) {
      if (!electionAddress) return null;
      const encoded = encodeURIComponent(electionAddress);
      try {
        const resp = await fetch(`/api/elections/${encoded}/candidates`, { headers: { 'Accept': 'application/json' }});
        if (!resp.ok) return null;
        const body = await safeJson(resp);
        let candidates = [];
        if (Array.isArray(body)) candidates = body;
        else candidates = body?.candidates || body?.data?.candidates || [];

        if (!candidates || candidates.length === 0) return null;

        // determine winner by numeric vote count, fallback to first if no votes available
        let winner = null;
        let maxVotes = -1;
        for (const c of candidates) {
          // support multiple naming conventions from backend
          const v = Number(c.voteCount || c.votes || c.vote_count || 0);
          const votes = isNaN(v) ? 0 : v;
          if (votes > maxVotes) {
            maxVotes = votes;
            winner = c;
          }
        }
        // if all votes 0 and winner is null, pick candidate[0]
        if (!winner && candidates.length > 0) winner = candidates[0];

        // Normalize winner object: name, email, votes
        if (winner) {
          return {
            name: winner.name || winner.candidate_name || winner.candidate || '(unnamed)',
            email: winner.email || winner.candidate_email || '',
            voteCount: Number(winner.voteCount || winner.votes || winner.vote_count || 0)
          };
        }
        return null;
      } catch (err) {
        console.error('computeWinner error', err);
        return null;
      }
    }

    // --- end election handler: compute winner, POST to /api/voter/resultMail with required fields ---
    async function endElectionHandler() {
      const btn = document.getElementById('endElection');
      const addr = getElectionAddress();
      if (!addr) { alert('No election selected'); return; }
      if (!confirm('End election and send result mail to all voters?')) return;

      try {
        // UI lock
        btn.disabled = true;
        btn.textContent = 'Ending election...';
        btn.classList.add('opacity-60', 'cursor-not-allowed');

        // get election name from page (fallback to prompt)
        let electionName = document.getElementById('electionName')?.textContent || '';
        if (!electionName || electionName.trim() === '' || electionName === 'Unnamed election') {
          const promptName = prompt('Election name is missing — enter election name to include in the mail (required):');
          if (!promptName) { throw new Error('Election name required'); }
          electionName = promptName;
        }

        // compute winner from blockchain-backed candidates endpoint
        const winner = await computeWinner(addr);
        let winnerName = '';
        let candidateEmail = '';

        if (winner && winner.name) {
          winnerName = winner.name;
          candidateEmail = winner.email || '';
        } else {
          // fallback: ask admin to enter winner manually (required)
          const manual = prompt('Could not determine winner automatically. Enter winner candidate name (required):');
          if (!manual) { throw new Error('Winner candidate required'); }
          winnerName = manual;
        }

        // Build payload required by backend: election_address, election_name, winner_candidate
        const payload = {
          election_address: addr,
          election_name: electionName,
          winner_candidate: winnerName
        };
        // include candidate_email when available
        if (candidateEmail) payload.candidate_email = candidateEmail;

        // POST to backend
        const resp = await fetch('/api/voter/resultMail', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
          body: JSON.stringify(payload)
        });

        const json = await safeJson(resp);

        if (resp.ok && (json?.status === 'success' || json?.success === true)) {
          alert('Result emails sent successfully.');
        } else {
          // server returned error object; show useful message when available
          const msg = (json && (json.message || json.error)) || `Failed to send mails (${resp.status})`;
          alert('Error: ' + msg);
        }

      } catch (err) {
        console.error('endElectionHandler error', err);
        alert('Failed to end election: ' + (err.message || 'Unknown error'));
      } finally {
        // restore UI
        const btn = document.getElementById('endElection');
        if (btn) {
          btn.disabled = false;
          btn.textContent = 'End Election (mail)';
          btn.classList.remove('opacity-60', 'cursor-not-allowed');
        }
      }
    }

    // --- navigation & event wiring ---
    function navTo(page) {
      const addr = getElectionAddress();
      const q = addr ? `?address=${encodeURIComponent(addr)}` : '';
      window.location.href = `${page}${q}`;
    }

    document.getElementById('candidatesBtn').addEventListener('click', () => navTo('candidate_list.html'));
    document.getElementById('votersBtn').addEventListener('click', () => navTo('voting_list.html'));
    document.getElementById('dashboardBtn').addEventListener('click', () => navTo('company_dashboard.html'));
    document.getElementById('createBtn').addEventListener('click', () => window.location.href = 'create_election.html');

    document.getElementById('logoutBtn').addEventListener('click', function() {
      localStorage.removeItem('companyElectionAddress');
      localStorage.removeItem('companyEmail');
      Cookies.remove('company_email', { path: '/' });
      Cookies.remove('address', { path: '/' });
      window.location.href = 'homepage.html';
    });

    document.getElementById('viewCandidates').addEventListener('click', () => navTo('candidate_list.html'));
    document.getElementById('manageVoters').addEventListener('click', () => navTo('voting_list.html'));

    // Attach end election handler (this is the updated, full implementation)
    document.getElementById('endElection').addEventListener('click', endElectionHandler);

    // --- init page ---
    updateHeaderDisplays();
    loadDashboard();

    // Optional: refresh stats every 60s
    setInterval(loadDashboard, 60_000);
  </script>
</body>
</html>
